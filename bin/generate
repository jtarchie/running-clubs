#!/usr/bin/env ruby
# frozen_string_literal: true

require 'erb'
require 'kramdown'
require 'optparse'
require 'uri'
require_relative '../lib/facebook'

options = {}
opts_parser = OptionParser.new do |opts|
  opts.on('-o', '--output-dir DIRECTORY', 'output directory to place site into') do |v|
    options[:output_dir] = v
  end
  opts.on('-c', '--cache', 'cache the scraping') do |_v|
    options[:cache] = true
  end
end
opts_parser.parse!
raise '--output-dir is required' unless options[:output_dir]

facebook = Facebook.new(
  username: ENV.fetch('FACEBOOK_USERNAME'),
  password: ENV.fetch('FACEBOOK_PASSWORD'),
  cache: options[:cache]
)

facebook.login!

City = Struct.new(:name) do
  def to_s
    name
  end

  def slug
    name.downcase.gsub(/\W/, '')
  end
end
Group = Struct.new(:id, :name)
groups_by_city = {
  City.new('Denver') => [
    Group.new('112582942107236', 'Foothills Running and Cycling Club'),
    Group.new('124886367564642', 'Highland Tap and Burger Run Club'),
    Group.new('1528173973929011', 'Runners Roost Stapleton'),
    Group.new('1743154215930862', 'Arvada Runners'),
    Group.new('201896876473', 'Boulder Running Company @ Greenwood Village'),
    Group.new('305158679071', 'Runners Roost Lone Tree'),
    Group.new('338344882975485', 'Boulder Running Company @ Cherry Creek'),
    Group.new('918204988192108', 'Denver Trail Runners'),
    Group.new('BPRunCO', 'Berkeley Park Running Company'),
    Group.new('Dirty30Running', 'Dirty 30 Running'),
    Group.new('RunnersRoostCO', 'Runners Roost'),
    Group.new('RunnersRoostLakewood', 'Runners Roost Lakewood'),
    Group.new('1052961164748398', 'FRXC  - Front Range Cross Country'),
    Group.new('lookoutmountainrunners', 'Golden Mountain Runners')
  ],
  City.new('Boulder') => [
    Group.new('BoulderRunningCompany', 'Boulder Running Company')
  ],
  City.new('Fort Collins') => [
    Group.new('416963631832940', 'Fort Collins Trail Runners')
  ]
}

output_dir = options[:output_dir]
system("rm -Rf #{output_dir} && mkdir -p #{output_dir}")
system("cp assets/colorado.svg #{output_dir}")

cutoff_time = Time.now + 30 * 24 * 3600

Dir.chdir(output_dir) do
  events_by_city = groups_by_city.map do |(city, groups)|
    events_by_date = groups.flat_map do |group|
      facebook.events(id: group.id).select do |event|
        event.timestamp && event.timestamp < cutoff_time
      end.each do |event|
        event.group = group
      end
    end.group_by do |event|
      event.timestamp.to_date.to_s
    end
    [city, events_by_date]
  end.to_h

  File.write('index.html', ERB.new(DATA.read).result(binding))
  File.write('CNAME', 'denverrunners.com')

  system('git init')
  system('git remote add origin git@github.com:jtarchie/running-clubs.git')
  system('git add -A')
  system('git co -b gh-pages')
  system('git commit -m "updated"')
  system('git push origin gh-pages -f')
end

__END__
<html>
<head>
  <link rel="shortcut icon" href="/colorado.svg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:description" content="Colorado Runners aggregates running groups, stores, etc. for convenience. Hoping to help grow the community.">
  <meta property="og:title" content="Colorado Running Clubs">
  <meta property="og:url" content="https://denverrunners.com">
  <title>Colorado Running Clubs</title>
  <style>
    .icon-co {
    background-image: url(/colorado.svg);
    }
  </style>
</head>
<body>
  <header class="row">
    <a href="/" class="button logo"><span class="icon-co"></span>Running Clubs</a>
    <a href="#about" class="button">About</a>
    <% events_by_city.each do |city, _| %>
    <a href="#<%= city.slug %>" class="button"><%= city.to_s %></a>
    <% end %>
    <a href="mailto:jtarchie+runningclubs@gmail.com" class="button">Contact</a>
  </header>
  <div class="container">
    <div class="col-sm-12 col-md-10 col-md-offset-1 col-lg-8 col-lg-offset-2">
      <div class="card fluid">
        <div class="section">
          <h1 id="about">About</h1>
          <p>Colorado has a large running community. It is daunting to navigate all the meetups and events.</p>
          <p>Colorado Runners aggregates running groups, stores, etc. for convenience. Hoping to help grow the community.</p>
        </div>
      </div>
      <% events_by_city.each do |city, events_by_dates| %>
        <div class="card fluid">
          <div class="section">
          <h1 id="<%= city.slug %>"><%= city.to_s %></h1>
            <% if events_by_dates.length.zero? %>
              <p>There are currently no events scheduled in this area.</p>
            <% end %>
          </div>
          <% events_by_dates.keys.sort.each do |date| %>
            <% events = events_by_dates[date] %>
            <div class="section">
              <h2><%= date %></h2>
            </div>
            <div class="section">
              <% events.each do |event| %>
                <h3>
                  <a href="<%= event.link %>" title="<%= event.title %>" target="_blank" rel="noopener"><%= event.title %></a>
                  <small>
                    hosted by <a href="https://facebook.com/<%= event.group.id %>" target="_blank" rel="noopener"><%= event.group.name %></a>
                  </small>
                </h3>
                <p>Start: <%= event.timestamp.strftime("%I:%M %p") %></p>
                <% if event[:location] %>
                   <p>Location: <a href="https://www.google.com/maps?q=<%= URI.escape(event.location) %>" target="_blank" rel="noopener"><%= event.location %></a></p>
                <% end %>
                <%= Kramdown::Document.new(event.description || '').to_html %>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
  <footer class="row">
    <p>
      &copy;<%= Time.now.year %> Running Clubs |
      <a class="button" target="_blank" href="https://github.com/jtarchie/running-clubs">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="height: 20px; vertical-align: text-top;"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
        Github
      </a>
    </p>
  </footer>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112531804-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-112531804-1');
  </script>
</body>
</html>
